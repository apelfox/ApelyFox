<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telegram Coin Miner</title>
    
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #111111; --card-bg-color: #1e1e1e; --text-primary: #f5f5f5;
            --text-secondary: #888888; --accent-primary: #FFA500;
            --accent-gradient: linear-gradient(135deg, #FFB347, #FF6347);
            --border-color: rgba(255, 255, 255, 0.1); --shadow-color: rgba(0, 0, 0, 0.3);
            --glow-color: rgba(255, 165, 0, 0.4); --success-color: #4CAF50; --error-color: #F44336;
            --header-icon-bg: #333333; --pending-color: #ffc107; --approved-color: #4caf50; --rejected-color: #F44336;
        }
        body.light-mode {
            --bg-color: #f0f2f5; --card-bg-color: #ffffff; --text-primary: #1c1e21;
            --text-secondary: #606770; --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1); --glow-color: rgba(255, 165, 0, 0.3);
            --header-icon-bg: #e4e6eb;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; padding-bottom: 90px; }
        .app-container { max-width: 500px; margin: 0 auto; padding: 15px; position: relative; }
        
        /* Text Overflow Prevention */
        .user-name, .user-chat-id, .coin-display span, .nav-item span, .menu-profile-name, .menu-profile-username {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .user-profile { display: flex; align-items: center; gap: 10px; min-width: 0; flex: 1; }
        .user-profile-pic { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-primary); flex-shrink: 0; }
        .user-info { min-width: 0; flex: 1; }
        .user-info .user-name { font-weight: 600; font-size: 16px; max-width: 120px; }
        .user-info .user-chat-id { font-size: 12px; color: var(--text-secondary); max-width: 120px; }
        .header-controls { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .coin-display { display: flex; align-items: center; background: var(--card-bg-color); padding: 8px 12px; border-radius: 25px; gap: 8px; font-weight: 700; font-size: 16px; box-shadow: 0 2px 10px var(--shadow-color); max-width: 120px; }
        .coin-display img { width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0;}
        .coin-display span { max-width: 60px; }
        .theme-toggle-btn { background-color: var(--header-icon-bg); border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--text-primary); box-shadow: 0 2px 5px var(--shadow-color); flex-shrink: 0; }
        .theme-toggle-btn svg { width: 22px; height: 22px; }
        
        /* Iframe Container */
        .iframe-container { width: 100%; height: calc(100vh - 200px); border: none; border-radius: 15px; background: var(--bg-color); }
        .iframe-loading { display: flex; justify-content: center; align-items: center; height: 200px; color: var(--text-secondary); }
        
        /* Bottom Navigation - Fixed with keyboard protection */
        .bottom-nav { 
            position: fixed; 
            bottom: 15px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 95%; 
            max-width: 500px; 
            height: 70px; 
            background: var(--card-bg-color); 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            z-index: 1000; 
            border-radius: 25px; 
            box-shadow: 0 -4px 15px var(--shadow-color);
            /* Keyboard protection */
            transform: translateX(-50%) translateY(0);
            transition: transform 0.3s ease;
        }
        .bottom-nav.keyboard-up {
            transform: translateX(-50%) translateY(-250px);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 11px; font-weight: 500; cursor: pointer; color: var(--text-secondary); transition: color 0.2s; flex-basis: 0; flex-grow: 1; padding-top: 5px; max-width: 80px; }
        .nav-item span { max-width: 100%; }
        .nav-item.active { color: var(--accent-primary); font-weight: 700; }
        .nav-item svg { width: 24px; height: 24px; fill: var(--text-secondary); transition: fill 0.2s; }
        .nav-item.active svg { fill: var(--accent-primary); }
        .nav-item-main { transform: translateY(-25px); }
        .main-nav-button { width: 75px; height: 75px; background: var(--bg-color); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 5px solid var(--accent-primary); box-shadow: 0 0 20px 5px var(--glow-color); transition: all 0.3s; cursor: pointer; }
        .main-nav-button img { width: 90%; height: 90%; border-radius: 50%; }
        
        /* Side Menu */
        .side-menu { 
            position: fixed; 
            top: 0; 
            right: -100%; 
            width: 85%; 
            height: 100vh; 
            background: var(--card-bg-color); 
            z-index: 2000; 
            transition: right 0.3s ease;
            box-shadow: -5px 0 25px var(--shadow-color);
            overflow-y: auto;
            padding: 20px;
        }
        .side-menu.active { right: 0; }
        .menu-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1999; 
            display: none; 
        }
        .menu-overlay.active { display: block; }
        
        /* Menu Profile Section */
        .menu-profile { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            padding: 20px 0; 
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .menu-profile-pic { 
            width: 70px; 
            height: 70px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 3px solid var(--accent-primary);
            flex-shrink: 0;
        }
        .menu-profile-info { 
            min-width: 0; 
            flex: 1; 
        }
        .menu-profile-name { 
            font-size: 18px; 
            font-weight: 700; 
            margin-bottom: 5px;
            max-width: 200px;
        }
        .menu-profile-username { 
            font-size: 14px; 
            color: var(--text-secondary);
            margin-bottom: 8px;
            max-width: 200px;
        }
        .vip-badge { 
            display: inline-block; 
            background: var(--accent-gradient); 
            color: white; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600;
        }
        .free-badge { 
            display: inline-block; 
            background: var(--text-secondary); 
            color: white; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600;
        }
        
        /* Menu Items */
        .menu-items { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            margin-bottom: 30px;
        }
        .menu-item { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            padding: 15px; 
            background: var(--bg-color); 
            border-radius: 12px; 
            cursor: pointer;
            transition: all 0.2s;
        }
        .menu-item:hover { 
            transform: translateX(5px);
            background: var(--accent-primary);
            color: white;
        }
        .menu-item-icon { 
            width: 24px; 
            height: 24px; 
            display: flex; 
            justify-content: center; 
            align-items: center;
        }
        .menu-item-text { 
            font-weight: 500; 
            font-size: 16px;
        }
        
        /* Telegram Group Buttons */
        .telegram-buttons { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-top: 20px;
        }
        .tg-group-btn { 
            background: var(--accent-primary); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            font-weight: 600; 
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .tg-group-btn:hover { 
            background: var(--accent-gradient);
            transform: translateY(-2px);
        }
        
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 10px 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); z-index: 2000; opacity: 0; transition: opacity 0.3s, top 0.3s; pointer-events: none; }
        .notification.show { opacity: 1; top: 30px;}
        .notification.error { background-color: var(--error-color); }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="notification" id="notification"></div>

        <header class="app-header">
            <div class="user-profile">
                <img id="user-profile-pic" src="https://i.ibb.co/L0xJ182/placeholder.png" alt="Profile" class="user-profile-pic">
                <div class="user-info">
                    <div id="user-name" class="user-name">Guest User</div>
                    <div id="user-chat-id" class="user-chat-id">ID: Not Found</div>
                </div>
            </div>
            <div class="header-controls">
                <div class="coin-display">
                    <img src="https://i.ibb.co/qLc58ntq/1000105515.jpg" alt="Coin">
                    <span id="coin-amount">0</span>
                </div>
                <button class="theme-toggle-btn" id="theme-toggle-btn">
                    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.06-1.06l-1.591 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM21.75 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5H21a.75.75 0 0 1 .75.75ZM17.834 18.894a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 1 0-1.061 1.06l1.59 1.591ZM12 18a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-1.5 0v-2.25A.75.75 0 0 1 12 18ZM7.758 17.303a.75.75 0 0 0-1.061-1.06l-1.591 1.59a.75.75 0 0 0 1.06 1.061l1.591-1.59ZM6 12a.75.75 0 0 1-.75.75H3a.75.75 0 0 1 0-1.5h2.25A.75.75 0 0 1 6 12ZM6.697 7.757a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 0 0-1.061 1.06l1.59 1.591Z"/>
                    </svg>
                </button>
            </div>
        </header>

        <main>
            <!-- Iframe Container for External Pages -->
            <div id="iframe-container" class="iframe-container">
                <div class="iframe-loading" id="iframe-loading">
                    Loading...
                </div>
                <iframe 
                    id="content-frame" 
                    style="width: 100%; height: 100%; border: none; border-radius: 15px; display: none;"
                    allow="clipboard-write"
                ></iframe>
            </div>
        </main>
    </div>

    <!-- Side Menu -->
    <div class="menu-overlay" id="menu-overlay"></div>
    <div class="side-menu" id="side-menu">
        <!-- Profile Section -->
        <div class="menu-profile">
            <img id="menu-profile-pic" src="https://i.ibb.co/L0xJ182/placeholder.png" alt="Profile" class="menu-profile-pic">
            <div class="menu-profile-info">
                <div id="menu-profile-name" class="menu-profile-name">Guest User</div>
                <div id="menu-profile-username" class="menu-profile-username">@username - ID: 000000</div>
                <div id="vip-status">
                    <span class="free-badge" id="vip-badge">Free - VIP 0</span>
                </div>
            </div>
        </div>

        <!-- Menu Items -->
        <div class="menu-items">
            <div class="menu-item" data-file="upgrade-account.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.47 1.72a.75.75 0 0 1 1.06 0l3 3a.75.75 0 0 1-1.06 1.06l-1.72-1.72V7.5h-1.5V4.06L9.53 5.78a.75.75 0 0 1-1.06-1.06l3-3ZM11.25 7.5V15a.75.75 0 0 0 1.5 0V7.5h3.75a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-9a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h3.75Z"/>
                    </svg>
                </div>
                <div class="menu-item-text">Upgrade Account</div>
            </div>
            
            <div class="menu-item" data-file="withdraw.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2.25a.75.75 0 0 1 .75.75v16.19l2.47-2.47a.75.75 0 1 1 1.06 1.06l-3.75 3.75a.75.75 0 0 1-1.06 0l-3.75-3.75a.75.75 0 1 1 1.06-1.06l2.47 2.47V3a.75.75 0 0 1 .75-.75Z"/>
                    </svg>
                </div>
                <div class="menu-item-text">Withdraw to Transfer</div>
            </div>
            
            <div class="menu-item" data-file="deposit.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2.25a.75.75 0 0 1 .75.75v16.19l2.47-2.47a.75.75 0 1 1 1.06 1.06l-3.75 3.75a.75.75 0 0 1-1.06 0l-3.75-3.75a.75.75 0 1 1 1.06-1.06l2.47 2.47V3a.75.75 0 0 1 .75-.75Z"/>
                    </svg>
                </div>
                <div class="menu-item-text">Deposit Balance</div>
            </div>
            
            <div class="menu-item" data-file="daily-bonus.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 .75a8.25 8.25 0 0 0-4.135 15.39c.686.398 1.115 1.008 1.134 1.623a.75.75 0 0 0 .577.706c.352.083.71.148 1.074.195.323.041.6-.218.6-.544v-4.661a6.714 6.714 0 0 1-.937-.171.75.75 0 1 1 .374-1.453 5.261 5.261 0 0 0 2.626 0 .75.75 0 1 1 .374 1.452 6.712 6.712 0 0 1-.937.172v4.66c0 .327.277.586.6.545.364-.047.722-.112 1.074-.195a.75.75 0 0 0 .577-.706c.02-.615.448-1.225 1.134-1.623A8.25 8.25 0 0 0 12 .75Z"/>
                    </svg>
                </div>
                <div class="menu-item-text">Daily Free Bonus</div>
            </div>
            
            <div class="menu-item" data-file="invite-friend.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4.5 6.375a4.125 4.125 0 1 1 8.25 0 4.125 4.125 0 0 1-8.25 0ZM14.25 8.625a3.375 3.375 0 1 1 6.75 0 3.375 3.375 0 0 1-6.75 0ZM1.5 19.125a7.125 7.125 0 0 1 14.25 0v.003l-.001.119a.75.75 0 0 1-.363.63 13.067 13.067 0 0 1-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 0 1-.364-.63l-.001-.122ZM17.25 19.128l-.001.144a2.25 2.25 0 0 1-.233.96 10.088 10.088 0 0 0 5.06-1.01.75.75 0 0 0 .42-.643 4.875 4.875 0 0 0-6.957-4.611 8.586 8.586 0 0 1 1.71 5.157v.003Z"/>
                    </svg>
                </div>
                <div class="menu-item-text">Invite Friend</div>
            </div>
        </div>

        <!-- Telegram Group Buttons -->
        <div class="telegram-buttons">
            <button class="tg-group-btn" data-link="https://t.me/your_main_group">
                Main Group
            </button>
            <button class="tg-group-btn" data-link="https://t.me/your_support_group">
                Support Group
            </button>
        </div>
    </div>

    <nav class="bottom-nav" id="bottom-nav">
        <div class="nav-item active" data-page="home" data-file="home.html">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11.47 3.84a.75.75 0 0 1 1.06 0l8.69 8.69a.75.75 0 1 0 1.06-1.06l-8.689-8.69a2.25 2.25 0 0 0-3.182 0l-8.69 8.69a.75.75 0 0 0 1.061 1.06l8.69-8.69Z" />
                <path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 0 1-.75-.75v-4.5a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75V21a.75.75 0 0 1-.75.75H5.625a1.875 1.875 0 0 1-1.875-1.875v-6.198a2.29 2.29 0 0 0 .091-.086L12 5.43Z" />
            </svg>
            <span>Home</span>
        </div>
        <div class="nav-item" data-page="tasks" data-file="tasks.html">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3.75 3h16.5a.75.75 0 0 1 .75.75v16.5a.75.75 0 0 1-.75.75H3.75a.75.75 0 0 1-.75-.75V3.75a.75.75 0 0 1 .75-.75ZM5.25 4.5v15h13.5V4.5H5.25Zm3.22 2.03a.75.75 0 0 1 1.06-1.06l3 3a.75.75 0 0 1 0 1.06l-3 3a.75.75 0 0 1-1.06-1.06L10.94 9l-2.47-2.47Z"/>
            </svg>
            <span>Tasks</span>
        </div>
        <div class="nav-item nav-item-main" data-page="robot-mining" data-file="robot-mining.html">
            <div class="main-nav-button">
                <img src="https://i.ibb.co/qLc58ntq/1000105515.jpg" alt="Mining Icon">
            </div>
        </div>
        <div class="nav-item" data-page="invite" data-file="invite.html">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M10.5 4.5a3 3 0 0 0-3 3v.5a.75.75 0 0 0 1.5 0v-.5a1.5 1.5 0 0 1 1.5-1.5h3a1.5 1.5 0 0 1 1.5 1.5v.5a.75.75 0 0 0 1.5 0v-.5a3 3 0 0 0-3-3h-3ZM16.5 7.5a3 3 0 0 1 3 3v6a3 3 0 0 1-3 3h-9a3 3 0 0 1-3-3v-6a3 3 0 0 1 3-3h1.036a.75.75 0 0 1 0 1.5H7.5a1.5 1.5 0 0 0-1.5 1.5v6a1.5 1.5 0 0 0 1.5 1.5h9a1.5 1.5 0 0 0 1.5-1.5v-6a1.5 1.5 0 0 0-1.5-1.5h-1.036a.75.75 0 0 1 0-1.5H16.5Z"/>
            </svg>
            <span>Invite</span>
        </div>
        <div class="nav-item" id="menu-nav-item" data-page="menu">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm0 5.25a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" />
            </svg>
            <span>Menu</span>
        </div>
    </nav>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
const firebaseConfig = {
  apiKey: "AIzaSyDan31qsrOecKIs6wLUjWfWafIzq8oXWpY",
  authDomain: "apelyfox-164c1.firebaseapp.com",
  databaseURL: "https://apelyfox-164c1-default-rtdb.firebaseio.com",
  projectId: "apelyfox-164c1",
  storageBucket: "apelyfox-164c1.firebasestorage.app",
  messagingSenderId: "1081216277329",
  appId: "1:1081216277329:web:bfe0c3e9b4769d92e51170"
};

            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const auth = firebase.auth();
            const tg = window.Telegram.WebApp;
            tg.expand();

            // --- GLOBAL STATE ---
            let currentUserId = null;
            let userRef = null;
            let userPlanRef = null;
            let userState = {};
            let userPlanState = {};
            let currentTheme = 'dark';

            // --- DOM ELEMENTS ---
            const notification = document.getElementById('notification');
            const contentFrame = document.getElementById('content-frame');
            const iframeLoading = document.getElementById('iframe-loading');
            const navItems = document.querySelectorAll('.nav-item');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const themeIcon = document.getElementById('theme-icon');
            const bottomNav = document.getElementById('bottom-nav');
            const sideMenu = document.getElementById('side-menu');
            const menuOverlay = document.getElementById('menu-overlay');
            const menuNavItem = document.getElementById('menu-nav-item');

            // --- THEME MANAGEMENT ---
            function initTheme() {
                const savedTheme = localStorage.getItem('app-theme') || 'dark';
                currentTheme = savedTheme;
                applyTheme(savedTheme);
                updateThemeIcon();
            }

            function applyTheme(theme) {
                document.body.className = theme === 'light' ? 'light-mode' : '';
                localStorage.setItem('app-theme', theme);
                
                // Send theme to iframe
                if (contentFrame.contentWindow) {
                    try {
                        contentFrame.contentWindow.postMessage({
                            type: 'THEME_UPDATE',
                            theme: theme
                        }, '*');
                    } catch (e) {
                        console.log('Theme update to iframe failed');
                    }
                }
            }

            function updateThemeIcon() {
                if (currentTheme === 'light') {
                    themeIcon.innerHTML = '<path d="M21.752 15.002A9.72 9.72 0 0 1 12 20.25a9.72 9.72 0 0 1-9.752-5.248 9.75 9.75 0 1 1 19.504 0ZM12 7.5a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-1.5 0v-4.5A.75.75 0 0 1 12 7.5Z"/>';
                } else {
                    themeIcon.innerHTML = '<path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.06-1.06l-1.591 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM21.75 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5H21a.75.75 0 0 1 .75.75ZM17.834 18.894a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 1 0-1.061 1.06l1.59 1.591ZM12 18a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-1.5 0v-2.25A.75.75 0 0 1 12 18ZM7.758 17.303a.75.75 0 0 0-1.061-1.06l-1.591 1.59a.75.75 0 0 0 1.06 1.061l1.591-1.59ZM6 12a.75.75 0 0 1-.75.75H3a.75.75 0 0 1 0-1.5h2.25A.75.75 0 0 1 6 12ZM6.697 7.757a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 0 0-1.061 1.06l1.59 1.591Z"/>';
                }
            }

            themeToggleBtn.addEventListener('click', () => {
                currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
                applyTheme(currentTheme);
                updateThemeIcon();
            });

            // --- KEYBOARD PROTECTION ---
            function handleKeyboard() {
                const viewport = window.visualViewport;
                if (viewport) {
                    viewport.addEventListener('resize', () => {
                        if (viewport.height < window.innerHeight) {
                            bottomNav.classList.add('keyboard-up');
                        } else {
                            bottomNav.classList.remove('keyboard-up');
                        }
                    });
                }
            }

            // --- SIDE MENU MANAGEMENT ---
            function openSideMenu() {
                sideMenu.classList.add('active');
                menuOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeSideMenu() {
                sideMenu.classList.remove('active');
                menuOverlay.classList.remove('active');
                document.body.style.overflow = 'auto';
            }

            menuNavItem.addEventListener('click', openSideMenu);
            menuOverlay.addEventListener('click', closeSideMenu);

            // Menu item click handlers
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    const fileName = item.dataset.file;
                    loadPage(fileName, 'menu-page');
                    closeSideMenu();
                });
            });

            // Telegram group buttons
            document.querySelectorAll('.tg-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const link = btn.dataset.link;
                    window.open(link, '_blank');
                });
            });

            // --- NAVIGATION ---
            function loadPage(fileName, pageName) {
                iframeLoading.style.display = 'flex';
                contentFrame.style.display = 'none';

                // Construct URL with parameters
                const url = `${fileName}?userId=${currentUserId}&theme=${currentTheme}&userData=${encodeURIComponent(JSON.stringify({
                    name: userState.name,
                    coins: userState.coins,
                    chatId: currentUserId,
                    isPremium: userPlanState.premium || false,
                    vipLevel: userPlanState.vipLevel || 0
                }))}`;

                contentFrame.src = url;

                contentFrame.onload = () => {
                    iframeLoading.style.display = 'none';
                    contentFrame.style.display = 'block';
                    
                    // Send theme to iframe after load
                    setTimeout(() => {
                        contentFrame.contentWindow.postMessage({
                            type: 'THEME_UPDATE',
                            theme: currentTheme
                        }, '*');
                    }, 100);
                };

                contentFrame.onerror = () => {
                    iframeLoading.innerHTML = 'Error loading page';
                    contentFrame.style.display = 'none';
                };
            }

            function setActiveNav(pageName) {
                navItems.forEach(item => {
                    item.classList.toggle('active', item.dataset.page === pageName);
                });
            }

            navItems.forEach(item => {
                if (item.dataset.page !== 'menu') {
                    item.addEventListener('click', () => {
                        const pageName = item.dataset.page;
                        const fileName = item.dataset.file;
                        
                        setActiveNav(pageName);
                        loadPage(fileName, pageName);
                    });
                }
            });

            // --- MESSAGE LISTENER FOR IFRAME COMMUNICATION ---
            window.addEventListener('message', (event) => {
                if (event.data.type === 'COIN_UPDATE') {
                    updateCoinDisplay(event.data.coins);
                } else if (event.data.type === 'SHOW_NOTIFICATION') {
                    showNotification(event.data.message, event.data.isError);
                } else if (event.data.type === 'NAVIGATE_TO') {
                    // Navigate to different page from iframe
                    const targetPage = event.data.page;
                    const targetItem = document.querySelector(`[data-page="${targetPage}"]`);
                    if (targetItem) {
                        targetItem.click();
                    }
                }
            });

            // --- USER DATA MANAGEMENT ---
            function saveUserProfileToDatabase(tgUser) {
                const userData = {
                    telegramId: tgUser.id,
                    firstName: tgUser.first_name,
                    lastName: tgUser.last_name || '',
                    username: tgUser.username || '',
                    photoUrl: tgUser.photo_url || 'https://i.ibb.co/L0xJ182/placeholder.png',
                    languageCode: tgUser.language_code || 'en',
                    isPremium: tgUser.is_premium || false,
                    lastLogin: firebase.database.ServerValue.TIMESTAMP,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };

                // Save to users collection
                userRef.set(userData);

                // Initialize user plan if not exists
                userPlanRef.once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        const planData = {
                            premium: false,
                            vipLevel: 0,
                            joinDate: firebase.database.ServerValue.TIMESTAMP,
                            lastUpdated: firebase.database.ServerValue.TIMESTAMP
                        };
                        userPlanRef.set(planData);
                    }
                });
            }

            function updateMenuProfile() {
                document.getElementById('menu-profile-pic').src = userState.photoUrl || 'https://i.ibb.co/L0xJ182/placeholder.png';
                document.getElementById('menu-profile-name').textContent = 
                    userState.firstName + (userState.lastName ? ' ' + userState.lastName : '');
                
                const usernameText = userState.username ? `@${userState.username} - ` : '';
                document.getElementById('menu-profile-username').textContent = 
                    `${usernameText}ID: ${currentUserId}`;
                
                // Update VIP badge
                const vipBadge = document.getElementById('vip-badge');
                if (userPlanState.premium) {
                    vipBadge.textContent = `Premium - VIP ${userPlanState.vipLevel || 0}`;
                    vipBadge.className = 'vip-badge';
                } else {
                    vipBadge.textContent = `Free - VIP ${userPlanState.vipLevel || 0}`;
                    vipBadge.className = 'free-badge';
                }
            }

            // --- INITIALIZATION ---
            function initializeApp() {
                initTheme();
                handleKeyboard();

                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const user = tg.initDataUnsafe.user;
                    currentUserId = user.id.toString();
                    
                    // Update header with user info
                    document.getElementById('user-name').textContent = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                    document.getElementById('user-chat-id').textContent = `ID: ${currentUserId}`;
                    
                    if (user.photo_url) {
                        document.getElementById('user-profile-pic').src = user.photo_url;
                    }

                    userRef = database.ref('users/' + currentUserId);
                    userPlanRef = database.ref('usersPlanLevel/' + currentUserId);
                    
                    auth.signInAnonymously().catch(error => console.error("Auth Error:", error));
                    auth.onAuthStateChanged(authUser => {
                        if (authUser) {
                            // Listen for user data changes
                            userRef.on('value', snapshot => {
                                if (!snapshot.exists()) {
                                    createNewUser(user);
                                } else {
                                    userState = snapshot.val();
                                    if(userState.isBlocked) {
                                        document.body.innerHTML = '<h1>Your account has been blocked.</h1>';
                                        return;
                                    }
                                    updateCoinDisplay(userState.coins || 0);
                                    updateMenuProfile();
                                    
                                    // Load home page by default
                                    loadPage('home.html', 'home');
                                }
                            });

                            // Listen for user plan data changes
                            userPlanRef.on('value', snapshot => {
                                userPlanState = snapshot.val() || {};
                                updateMenuProfile();
                            });

                        }
                    });
                } else {
                    document.body.innerHTML = '<h1>Please open this app in Telegram.</h1>';
                }
            }

            function createNewUser(tgUser) {
                const startParam = tg.initDataUnsafe.start_param;
                const newUser = {
                    name: tgUser.first_name,
                    coins: 0,
                    totalMined: 0,
                    level: 1,
                    referrals: 0,
                    referralIncome: 0,
                    isBlocked: false,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    referrerId: startParam || null,
                    claimedReferral: false
                };
                userRef.set(newUser);
                
                // Save complete user profile to database
                saveUserProfileToDatabase(tgUser);
            }

            function updateCoinDisplay(coins) {
                document.getElementById('coin-amount').textContent = Math.floor(coins || 0).toLocaleString();
            }

            function showNotification(message, isError = false) {
                notification.textContent = message;
                notification.className = `notification show ${isError ? 'error' : ''}`;
                setTimeout(() => notification.classList.remove('show'), 3000);
            }

            // Start the app
            initializeApp();
        });
    </script>
</body>
</html>
