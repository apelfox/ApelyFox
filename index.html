<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telegram Coin Miner</title>
    
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #111111; --card-bg-color: #1e1e1e; --text-primary: #f5f5f5;
            --text-secondary: #888888; --accent-primary: #FFA500;
            --accent-gradient: linear-gradient(135deg, #FFB347, #FF6347);
            --border-color: rgba(255, 255, 255, 0.1); --shadow-color: rgba(0, 0, 0, 0.3);
            --glow-color: rgba(255, 165, 0, 0.4); --success-color: #4CAF50; --error-color: #F44336;
            --header-icon-bg: #333333; --pending-color: #ffc107; --approved-color: #4caf50; --rejected-color: #F44336;
        }
        body.light-mode {
            --bg-color: #f0f2f5; --card-bg-color: #ffffff; --text-primary: #1c1e21;
            --text-secondary: #606770; --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1); --glow-color: rgba(255, 165, 0, 0.3);
            --header-icon-bg: #e4e6eb;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; padding-bottom: 90px; }
        .app-container { max-width: 500px; margin: 0 auto; padding: 15px; position: relative; }
        
        /* Text Overflow Prevention */
        .user-name, .user-chat-id, .nav-item span, .menu-profile-name, .menu-profile-username {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .user-profile { display: flex; align-items: center; gap: 10px; min-width: 0; flex: 1; }
        .user-profile-pic { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-primary); flex-shrink: 0; }
        .user-info { min-width: 0; flex: 1; }
        .user-info .user-name { font-weight: 600; font-size: 16px; max-width: 120px; }
        .user-info .user-chat-id { font-size: 12px; color: var(--text-secondary); max-width: 120px; }
        .header-controls { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        
        /* Notification Bell */
        .notification-bell { 
            position: relative; 
            background-color: var(--header-icon-bg); 
            border: none; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            cursor: pointer; 
            color: var(--text-primary); 
            box-shadow: 0 2px 5px var(--shadow-color); 
        }
        .notification-bell svg { width: 22px; height: 22px; }
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--error-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .theme-toggle-btn { background-color: var(--header-icon-bg); border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--text-primary); box-shadow: 0 2px 5px var(--shadow-color); flex-shrink: 0; }
        .theme-toggle-btn svg { width: 22px; height: 22px; }
        
        /* Homepage Styles */
        .homepage-container { max-width: 100%; margin: 0 auto; }
        
        /* Slider Section */
        .slider-section { margin: 20px 0; position: relative; }
        .slider-container { position: relative; height: 180px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px var(--shadow-color); }
        .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.8s ease; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; text-align: center; padding: 20px; background-size: cover; background-position: center; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.7); }
        .slide.active { opacity: 1; }
        .slide-link { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block; }
        .slide-indicators { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 2; }
        .slide-indicator { width: 8px; height: 8px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); transition: all 0.3s ease; }
        .slide-indicator.active { background-color: white; transform: scale(1.2); }
        .slide-1 { background: linear-gradient(135deg, rgba(255, 179, 71, 0.8), rgba(255, 99, 71, 0.8)), url('https://img.freepik.com/free-vector/colorful-welcome-lettering-modern-banner-invitation_1017-50216.jpg?semt=ais_hybrid&w=740&q=80'); }
        .slide-2 { background: linear-gradient(135deg, rgba(255, 179, 71, 0.8), rgba(255, 99, 71, 0.8)), url('https://img.freepik.com/free-vector/stylish-welcome-lettering-banner-join-with-joy-happiness_1017-57675.jpg?semt=ais_hybrid&w=740&q=80'); }
        .slide-3 { background: linear-gradient(135deg, rgba(255, 179, 71, 0.8), rgba(255, 99, 71, 0.8)), url('https://static.vecteezy.com/system/resources/previews/010/925/820/non_2x/colorful-welcome-design-template-free-vector.jpg'); }
        .slider-dots { display: flex; justify-content: center; margin-top: 15px; gap: 10px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background-color: var(--text-secondary); cursor: pointer; transition: background-color 0.3s; }
        .dot.active { background-color: var(--accent-primary); }
        
        /* Balance Section */
        .balance-section { margin: 25px 0; }
        .balance-card { background-color: var(--card-bg-color); border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px var(--shadow-color); text-align: center; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .balance-label { font-size: 18px; margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .balance-icon { width: 24px; height: 24px; object-fit: contain; }
        .balance-amount { font-size: 36px; font-weight: bold; color: var(--accent-primary); margin-bottom: 25px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .balance-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; text-align: center; font-size: 16px; }
        .btn-primary { background: var(--accent-gradient); color: white; box-shadow: 0 4px 6px var(--glow-color); }
        .btn-secondary { background-color: var(--card-bg-color); color: var(--text-primary); border: 1px solid var(--border-color); box-shadow: 0 4px 6px var(--shadow-color); }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 6px 8px var(--glow-color); }
        
        /* User Rating Section */
        .rating-section { margin: 20px 0; }
        .rating-frame { width: 100%; height: 400px; border: none; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); background-color: var(--card-bg-color); }
        
        /* Loading State */
        .home-loading { text-align: center; padding: 20px; color: var(--text-secondary); display: none; }
        .spinner { border: 4px solid var(--border-color); border-left-color: var(--accent-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Iframe Container */
        .iframe-container { 
            width: 100%; 
            height: calc(100vh - 200px); 
            border: none; 
            border-radius: 15px; 
            background: var(--bg-color);
            display: none;
        }
        
        .iframe-loading { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 200px; 
            color: var(--text-secondary);
            flex-direction: column;
            gap: 20px;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        /* Notification Frame Modal */
        .notification-frame-modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: var(--bg-color); 
            z-index: 3000; 
            display: none;
        }
        .notification-frame-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--card-bg-color);
            border-bottom: 1px solid var(--border-color);
        }
        .notification-frame-title {
            font-weight: 600;
            font-size: 18px;
            color: var(--text-primary);
        }
        .close-notification-frame {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .notification-frame-content {
            height: calc(100vh - 60px);
            width: 100%;
        }
        .notification-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: var(--bg-color);
        }
        
        /* Bottom Navigation - Fixed with keyboard protection */
        .bottom-nav { 
            position: fixed; 
            bottom: 0;
            left: 0; 
            width: 100%; 
            height: 70px; 
            background: var(--card-bg-color); 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            z-index: 1000; 
            box-shadow: 0 -4px 15px var(--shadow-color);
            padding: 0 10px;
            transform: translateY(0);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 11px; font-weight: 500; cursor: pointer; color: var(--text-secondary); transition: color 0.2s; flex-basis: 0; flex-grow: 1; padding-top: 5px; max-width: 80px; }
        .nav-item span { max-width: 100%; }
        .nav-item.active { color: var(--accent-primary); font-weight: 700; }
        .nav-item svg { width: 24px; height: 24px; fill: var(--text-secondary); transition: fill 0.2s; }
        .nav-item.active svg { fill: var(--accent-primary); }
        .nav-item-main { transform: translateY(-25px); }
        .main-nav-button { width: 75px; height: 75px; background: var(--bg-color); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 5px solid var(--accent-primary); box-shadow: 0 0 20px 5px var(--glow-color); transition: all 0.3s; cursor: pointer; }
        .main-nav-button img { width: 90%; height: 90%; border-radius: 50%; }
        
        /* Side Menu */
        .side-menu { 
            position: fixed; 
            top: 0; 
            right: -100%; 
            width: 85%; 
            height: 100vh; 
            background: var(--card-bg-color); 
            z-index: 2000; 
            transition: right 0.3s ease;
            box-shadow: -5px 0 25px var(--shadow-color);
            overflow-y: auto;
            padding: 20px;
        }
        .side-menu.active { right: 0; }
        .menu-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1999; 
            display: none; 
        }
        .menu-overlay.active { display: block; }
        
        /* Menu Profile Section */
        .menu-profile { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            padding: 20px 0; 
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .menu-profile-pic { 
            width: 70px; 
            height: 70px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 3px solid var(--accent-primary);
            flex-shrink: 0;
        }
        .menu-profile-info { 
            min-width: 0; 
            flex: 1; 
        }
        .menu-profile-name { 
            font-size: 18px; 
            font-weight: 700; 
            margin-bottom: 5px;
            max-width: 200px;
        }
        .menu-profile-username { 
            font-size: 14px; 
            color: var(--text-secondary);
            margin-bottom: 8px;
            max-width: 200px;
        }
        .vip-badge { 
            display: inline-block; 
            background: var(--accent-gradient); 
            color: white; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600;
        }
        .free-badge { 
            display: inline-block; 
            background: var(--text-secondary); 
            color: white; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600;
        }
        
        /* Menu Items */
        .menu-items { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            margin-bottom: 20px;
        }
        .menu-item { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            padding: 15px; 
            background: var(--bg-color); 
            border-radius: 12px; 
            cursor: pointer;
            transition: all 0.2s;
        }
        .menu-item:hover { 
            transform: translateX(5px);
            background: var(--accent-primary);
            color: white;
        }
        .menu-item-icon { 
            width: 24px; 
            height: 24px; 
            display: flex; 
            justify-content: center; 
            align-items: center;
        }
        .menu-item-text { 
            font-weight: 500; 
            font-size: 16px;
        }
        
        /* Telegram Group Buttons */
        .telegram-buttons { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-top: 20px;
        }
        .tg-group-btn { 
            background: var(--accent-primary); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            font-weight: 600; 
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .tg-group-btn:hover { 
            background: var(--accent-gradient);
            transform: translateY(-2px);
        }
        
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 10px 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); z-index: 2000; opacity: 0; transition: opacity 0.3s, top 0.3s; pointer-events: none; }
        .notification.show { opacity: 1; top: 30px;}
        .notification.error { background-color: var(--error-color); }
        
        @media (max-width: 480px) {
            .balance-buttons { grid-template-columns: 1fr 1fr; gap: 10px; }
            .btn { padding: 10px 15px; font-size: 14px; }
            .balance-amount { font-size: 28px; }
            .slider-container { height: 150px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="notification" id="notification"></div>

        <header class="app-header">
            <div class="user-profile">
                <img id="user-profile-pic" src="https://i.ibb.co/L0xJ182/placeholder.png" alt="Profile" class="user-profile-pic">
                <div class="user-info">
                    <div id="user-name" class="user-name">Loading...</div>
                    <div id="user-chat-id" class="user-chat-id">ID: Loading...</div>
                </div>
            </div>
            <div class="header-controls">
                <button class="notification-bell" id="notification-bell">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M5.85 3.5a.75.75 0 0 0-1.117-1 9.719 9.719 0 0 0-2.348 4.876.75.75 0 0 0 1.479.248A8.219 8.219 0 0 1 5.85 3.5ZM19.267 2.5a.75.75 0 1 0-1.118 1 8.22 8.22 0 0 1 1.987 4.124.75.75 0 0 0 1.48-.248A9.72 9.72 0 0 0 19.266 2.5Z"/>
                        <path fill-rule="evenodd" d="M12 2.25A6.75 6.75 0 0 0 5.25 9v.75a8.217 8.217 0 0 1-2.119 5.52.75.75 0 0 0 .298 1.206c1.544.57 3.16.99 4.831 1.243a3.75 3.75 0 1 0 7.48 0 24.583 24.583 0 0 0 4.83-1.244.75.75 0 0 0 .298-1.205 8.217 8.217 0 0 1-2.118-5.52V9A6.75 6.75 0 0 0 12 2.25ZM9.75 18c0-.034 0-.067.002-.1a25.05 25.05 0 0 0 4.496 0l.002.1a2.25 2.25 0 1 1-4.5 0Z" clip-rule="evenodd"/>
                    </svg>
                    <div class="notification-badge" id="notification-badge" style="display: none;">0</div>
                </button>
                <button class="theme-toggle-btn" id="theme-toggle-btn">
                    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.06-1.06l-1.591 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM21.75 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5H21a.75.75 0 0 1 .75.75ZM17.834 18.894a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 1 0-1.061 1.06l1.59 1.591ZM12 18a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-1.5 0v-2.25A.75.75 0 0 1 12 18ZM7.758 17.303a.75.75 0 0 0-1.061-1.06l-1.591 1.59a.75.75 0 0 0 1.06 1.061l1.591-1.59ZM6 12a.75.75 0 0 1-.75.75H3a.75.75 0 0 1 0-1.5h2.25A.75.75 0 0 1 6 12ZM6.697 7.757a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 0 0-1.061 1.06l1.59 1.591Z"/>
                    </svg>
                </button>
            </div>
        </header>

        <main>
            <!-- Homepage Content -->
            <div id="homepage-content">
                <div class="homepage-container">
                    <!-- Slider Section -->
                    <section class="slider-section">
                        <div class="slider-container">
                            <div class="slide slide-1 active">
                                <a href="#" class="slide-link" target="_blank"></a>
                                <div class="slide-indicators">
                                    <div class="slide-indicator active" data-slide="0"></div>
                                    <div class="slide-indicator" data-slide="1"></div>
                                    <div class="slide-indicator" data-slide="2"></div>
                                </div>
                            </div>
                            <div class="slide slide-2">
                                <a href="#" class="slide-link" target="_blank"></a>
                                <div class="slide-indicators">
                                    <div class="slide-indicator" data-slide="0"></div>
                                    <div class="slide-indicator active" data-slide="1"></div>
                                    <div class="slide-indicator" data-slide="2"></div>
                                </div>
                            </div>
                            <div class="slide slide-3">
                                <a href="#" class="slide-link" target="_blank"></a>
                                <div class="slide-indicators">
                                    <div class="slide-indicator" data-slide="0"></div>
                                    <div class="slide-indicator" data-slide="1"></div>
                                    <div class="slide-indicator active" data-slide="2"></div>
                                </div>
                            </div>
                        </div>
                        <div class="slider-dots">
                            <div class="dot active" data-slide="0"></div>
                            <div class="dot" data-slide="1"></div>
                            <div class="dot" data-slide="2"></div>
                        </div>
                    </section>

                    <!-- Balance Section -->
                    <section class="balance-section">
                        <div class="balance-card">
                            <div class="balance-label">
                                <img src="https://i.ibb.co/Z66872zq/ApelyFox.png" alt="Wallet Icon" class="balance-icon">
                                Main Balance
                            </div>
                            <div class="balance-amount" id="balance-amount">Loading...</div>
                            <div class="balance-buttons">
                                <button class="btn btn-primary" id="withdraw-btn">Withdraw</button>
                                <button class="btn btn-secondary" id="wallet-btn">All Wallet</button>
                            </div>
                        </div>
                    </section>

                    <!-- User Rating Section -->
                    <section class="rating-section">
                        <iframe class="rating-frame" id="rating-frame" src=""></iframe>
                    </section>
                </div>
            </div>

            <!-- Loading State -->
            <div class="home-loading" id="home-loading">
                <div class="spinner"></div>
                <div>Loading homepage...</div>
            </div>

            <!-- Iframe Container for Other Pages -->
            <div id="iframe-container" class="iframe-container">
                <div class="iframe-loading" id="iframe-loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Loading content...</div>
                </div>
                <iframe 
                    id="content-frame" 
                    style="width: 100%; height: 100%; border: none; border-radius: 15px; display: none;"
                    allow="clipboard-write"
                ></iframe>
            </div>
        </main>
    </div>

    <!-- Notification Frame Modal -->
    <div class="notification-frame-modal" id="notification-frame-modal">
        <div class="notification-frame-header">
            <div class="notification-frame-title">Notifications</div>
            <button class="close-notification-frame" id="close-notification-frame">&times;</button>
        </div>
        <div class="notification-frame-content">
            <iframe class="notification-frame" id="notification-frame" src=""></iframe>
        </div>
    </div>

    <!-- Side Menu -->
    <div class="menu-overlay" id="menu-overlay"></div>
    <div class="side-menu" id="side-menu">
        <!-- Profile Section -->
        <div class="menu-profile">
            <img id="menu-profile-pic" src="https://i.ibb.co/L0xJ182/placeholder.png" alt="Profile" class="menu-profile-pic">
            <div class="menu-profile-info">
                <div id="menu-profile-name" class="menu-profile-name">Loading...</div>
                <div id="menu-profile-username" class="menu-profile-username">Loading...</div>
                <div id="vip-status">
                    <span class="free-badge" id="vip-badge">Free - VIP 0</span>
                </div>
            </div>
        </div>

        <!-- Menu Items -->
        <div class="menu-items">
            <div class="menu-item" data-file="error/index.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.47 1.72a.75.75 0 0 1 1.06 0l3 3a.75.75 0 0 1-1.06 1.06l-1.72-1.72V7.5h-1.5V4.06L9.53 5.78a.75.75 0 0 1-1.06-1.06l3-3ZM11.25 7.5V15a.75.75 0 0 0 1.5 0V7.5h3.75a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-9a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h3.75Z"/>
                    </svg>
                </div>
                <div class="menu-item-text">Upgrade Account</div>
            </div>
            
            <div class="menu-item" data-file="error/index.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2.25a.75.75 0 0 1 .75.75v16.19l2.47-2.47a.75.75 0 1 1 1.06 1.06l-3.75 3.75a.75.75 0 0 1-1.06 0l-3.75-3.75a.75.75 0 1 1 1.06-1.06l2.47 2.47V3a.75.75 0 0 1 .75-.75Z"/>
                    </svg>
                </div>
                <div class="menu-item-text">Withdraw to Transfer</div>
            </div>
            
            <div class="menu-item" data-file="depoSit/deposit.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2.25a.75.75 0 0 1 .75.75v16.19l2.47-2.47a.75.75 0 1 1 1.06 1.06l-3.75 3.75a.75.75 0 0 1-1.06 0l-3.75-3.75a.75.75 0 1 1 1.06-1.06l2.47 2.47V3a.75.75 0 0 1 .75-.75Z"/>
                    </svg>
                </div>
                <div class="menu-item-text">Deposit Balance</div>
            </div>

            <div class="menu-item" data-file="error/index.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4.5 3.75a3 3 0 0 0-3 3v.75h21v-.75a3 3 0 0 0-3-3h-15Z"/>
                        <path fill-rule="evenodd" d="M22.5 9.75h-21v7.5a3 3 0 0 0 3 3h15a3 3 0 0 0 3-3v-7.5Zm-18 3.75a.75.75 0 0 1 .75-.75h6a.75.75 0 0 1 0 1.5h-6a.75.75 0 0 1-.75-.75Zm.75 2.25a.75.75 0 0 0 0 1.5h3a.75.75 0 0 0 0-1.5h-3Z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="menu-item-text">Transaction History</div>
            </div>
            
            <div class="menu-item" data-file="error/index.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 .75a8.25 8.25 0 0 0-4.135 15.39c.686.398 1.115 1.008 1.134 1.623a.75.75 0 0 0 .577.706c.352.083.71.148 1.074.195.323.041.6-.218.6-.544v-4.661a6.714 6.714 0 0 1-.937-.171.75.75 0 1 1 .374-1.453 5.261 5.261 0 0 0 2.626 0 .75.75 0 1 1 .374 1.452 6.712 6.712 0 0 1-.937.172v4.66c0 .327.277.586.6.545.364-.047.722-.112 1.074-.195a.75.75 0 0 0 .577-.706c.02-.615.448-1.225 1.134-1.623A8.25 8.25 0 0 0 12 .75Z"/>
                    </svg>
                </div>
                <div class="menu-item-text">Daily Free Bonus</div>
            </div>

            <div class="menu-item" data-file="totalWork/adsMining.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13.5 3.75a3 3 0 1 1 3 3 3 3 0 0 1-3-3ZM4.5 21.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 10.5v9a2.25 2.25 0 0 0 2.25 2.25Z"/>
                    </svg>
                </div>
                <div class="menu-item-text">Ads Mining</div>
            </div>

            <div class="menu-item" data-file="error/index.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-3 10.5a.75.75 0 0 1 0-1.5h6a.75.75 0 0 1 0 1.5H9Z"/>
                    </svg>
                </div>
                <div class="menu-item-text">Robot Mining</div>
            </div>

            <div class="menu-item" data-file="error/index.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.25 4.533A9.707 9.707 0 0 0 6 3a9.735 9.735 0 0 0-3.25.555.75.75 0 0 0-.5.707v14.25a.75.75 0 0 0 1 .707A8.237 8.237 0 0 1 6 18.75c1.995 0 3.823.707 5.25 1.886V4.533ZM12.75 20.636A8.214 8.214 0 0 1 18 18.75c.966 0 1.89.166 2.75.47a.75.75 0 0 0 1-.708V4.262a.75.75 0 0 0-.5-.707A9.735 9.735 0 0 0 18 3a9.707 9.707 0 0 0-5.25 1.533v16.103Z"/>
                    </svg>
                </div>
                <div class="menu-item-text">Supper Microjob</div>
            </div>

            <div class="menu-item" data-file="error/index.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2.25a.75.75 0 0 1 .75.75v.75a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.06-1.06l-1.591 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM21.75 12a.75.75 0 0 1-.75.75h-.75a.75.75 0 0 1 0-1.5H21a.75.75 0 0 1 .75.75ZM17.834 18.894a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 1 0-1.061 1.06l1.59 1.591ZM12 18a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-1.5 0v-2.25A.75.75 0 0 1 12 18ZM7.758 17.303a.75.75 0 0 0-1.061-1.06l-1.591 1.59a.75.75 0 0 0 1.06 1.061l1.591-1.59ZM6 12a.75.75 0 0 1-.75.75H3a.75.75 0 0 1 0-1.5h2.25A.75.75 0 0 1 6 12ZM6.697 7.757a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 0 0-1.061 1.06l1.59 1.591Z"/>
                    </svg>
                </div>
                <div class="menu-item-text">Lottery</div>
            </div>
            
            <div class="menu-item" data-file="error/index.html">
                <div class="menu-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4.5 6.375a4.125 4.125 0 1 1 8.25 0 4.125 4.125 0 0 1-8.25 0ZM14.25 8.625a3.375 3.375 0 1 1 6.75 0 3.375 3.375 0 0 1-6.75 0ZM1.5 19.125a7.125 7.125 0 0 1 14.25 0v.003l-.001.119a.75.75 0 0 1-.363.63 13.067 13.067 0 0 1-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 0 1-.364-.63l-.001-.122ZM17.25 19.128l-.001.144a2.25 2.25 0 0 1-.233.96 10.088 10.088 0 0 0 5.06-1.01.75.75 0 0 0 .42-.643 4.875 4.875 0 0 0-6.957-4.611 8.586 8.586 0 0 1 1.71 5.157v.003Z"/>
                    </svg>
                </div>
                <div class="menu-item-text">Invite Friend</div>
            </div>
        </div>

        <!-- Telegram Group Buttons -->
        <div class="telegram-buttons">
            <button class="tg-group-btn" data-link="https://t.me/hason_rajaM">
                Main Group
            </button>
            <button class="tg-group-btn" data-link="https://t.me/mdbyoc">
                Support Group
            </button>
        </div>
    </div>

    <nav class="bottom-nav" id="bottom-nav">
        <div class="nav-item active" data-page="home" data-file="home">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11.47 3.84a.75.75 0 0 1 1.06 0l8.69 8.69a.75.75 0 1 0 1.06-1.06l-8.689-8.69a2.25 2.25 0 0 0-3.182 0l-8.69 8.69a.75.75 0 0 0 1.061 1.06l8.69-8.69Z" />
                <path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 0 1-.75-.75v-4.5a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75V21a.75.75 0 0 1-.75.75H5.625a1.875 1.875 0 0 1-1.875-1.875v-6.198a2.29 2.29 0 0 0 .091-.086L12 5.43Z" />
            </svg>
            <span>Home</span>
        </div>
        <div class="nav-item" data-page="tasks" data-file="totalWork/adsMining.html">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3.75 3h16.5a.75.75 0 0 1 .75.75v16.5a.75.75 0 0 1-.75.75H3.75a.75.75 0 0 1-.75-.75V3.75a.75.75 0 0 1 .75-.75ZM5.25 4.5v15h13.5V4.5H5.25Zm3.22 2.03a.75.75 0 0 1 1.06-1.06l3 3a.75.75 0 0 1 0 1.06l-3 3a.75.75 0 0 1-1.06-1.06L10.94 9l-2.47-2.47Z"/>
            </svg>
            <span>Tasks</span>
        </div>
        <div class="nav-item nav-item-main" data-page="robot-mining" data-file="robot-mining.html">
            <div class="main-nav-button">
                <img src="https://i.ibb.co/Z66872zq/ApelyFox.png" alt="Mining Icon">
            </div>
        </div>
        <div class="nav-item" data-page="invite" data-file="error/index.html">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M10.5 4.5a3 3 0 0 0-3 3v.5a.75.75 0 0 0 1.5 0v-.5a1.5 1.5 0 0 1 1.5-1.5h3a1.5 1.5 0 0 1 1.5 1.5v.5a.75.75 0 0 0 1.5 0v-.5a3 3 0 0 0-3-3h-3ZM16.5 7.5a3 3 0 0 1 3 3v6a3 3 0 0 1-3 3h-9a3 3 0 0 1-3-3v-6a3 3 0 0 1 3-3h1.036a.75.75 0 0 1 0 1.5H7.5a1.5 1.5 0 0 0-1.5 1.5v6a1.5 1.5 0 0 0 1.5 1.5h9a1.5 1.5 0 0 0 1.5-1.5v-6a1.5 1.5 0 0 0-1.5-1.5h-1.036a.75.75 0 0 1 0-1.5H16.5Z"/>
            </svg>
            <span>Invite</span>
        </div>
        <div class="nav-item" id="menu-nav-item" data-page="menu">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm0 5.25a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" />
            </svg>
            <span>Menu</span>
        </div>
    </nav>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
const firebaseConfig = {
  apiKey: "AIzaSyDan31qsrOecKIs6wLUjWfWafIzq8oXWpY",
  authDomain: "apelyfox-164c1.firebaseapp.com",
  databaseURL: "https://apelyfox-164c1-default-rtdb.firebaseio.com",
  projectId: "apelyfox-164c1",
  storageBucket: "apelyfox-164c1.firebasestorage.app",
  messagingSenderId: "1081216277329",
  appId: "1:1081216277329:web:bfe0c3e9b4769d92e51170"
};

            
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const auth = firebase.auth();
            const tg = window.Telegram.WebApp;
            
            // Initialize Telegram Web App
            tg.ready();
            tg.expand();

            // --- GLOBAL STATE ---
            let currentUserId = null;
            let userRef = null;
            let userPlanRef = null;
            let notificationsRef = null;
            let userState = {};
            let userPlanState = {};
            let currentTheme = 'dark';
            let unreadNotifications = 0;

            // --- DOM ELEMENTS ---
            const notification = document.getElementById('notification');
            const contentFrame = document.getElementById('content-frame');
            const iframeLoading = document.getElementById('iframe-loading');
            const iframeContainer = document.getElementById('iframe-container');
            const homepageContent = document.getElementById('homepage-content');
            const homeLoading = document.getElementById('home-loading');
            const navItems = document.querySelectorAll('.nav-item');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const themeIcon = document.getElementById('theme-icon');
            const bottomNav = document.getElementById('bottom-nav');
            const sideMenu = document.getElementById('side-menu');
            const menuOverlay = document.getElementById('menu-overlay');
            const menuNavItem = document.getElementById('menu-nav-item');
            const notificationBell = document.getElementById('notification-bell');
            const notificationBadge = document.getElementById('notification-badge');
            const notificationFrameModal = document.getElementById('notification-frame-modal');
            const closeNotificationFrame = document.getElementById('close-notification-frame');
            const notificationFrame = document.getElementById('notification-frame');

            // Homepage Elements
            const balanceAmountElement = document.getElementById('balance-amount');
            const withdrawBtn = document.getElementById('withdraw-btn');
            const walletBtn = document.getElementById('wallet-btn');
            const ratingFrame = document.getElementById('rating-frame');
            const slides = document.querySelectorAll('.slide');
            const dots = document.querySelectorAll('.dot');
            const slideIndicators = document.querySelectorAll('.slide-indicator');

            // --- THEME MANAGEMENT ---
            function initTheme() {
                const savedTheme = localStorage.getItem('app-theme') || 'dark';
                currentTheme = savedTheme;
                applyTheme(savedTheme);
                updateThemeIcon();
            }

            function applyTheme(theme) {
                document.body.className = theme === 'light' ? 'light-mode' : '';
                localStorage.setItem('app-theme', theme);
            }

            function updateThemeIcon() {
                if (currentTheme === 'light') {
                    themeIcon.innerHTML = '<path d="M21.752 15.002A9.72 9.72 0 0 1 12 20.25a9.72 9.72 0 0 1-9.752-5.248 9.75 9.75 0 1 1 19.504 0ZM12 7.5a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-1.5 0v-4.5A.75.75 0 0 1 12 7.5Z"/>';
                } else {
                    themeIcon.innerHTML = '<path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.06-1.06l-1.591 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM21.75 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5H21a.75.75 0 0 1 .75.75ZM17.834 18.894a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 1 0-1.061 1.06l1.59 1.591ZM12 18a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-1.5 0v-2.25A.75.75 0 0 1 12 18ZM7.758 17.303a.75.75 0 0 0-1.061-1.06l-1.591 1.59a.75.75 0 0 0 1.06 1.061l1.591-1.59ZM6 12a.75.75 0 0 1-.75.75H3a.75.75 0 0 1 0-1.5h2.25A.75.75 0 0 1 6 12ZM6.697 7.757a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 0 0-1.061 1.06l1.59 1.591Z"/>';
                }
            }

            themeToggleBtn.addEventListener('click', () => {
                currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
                applyTheme(currentTheme);
                updateThemeIcon();
            });

            // --- HOMEPAGE SLIDER FUNCTIONALITY ---
            let currentSlide = 0;
            const slideCount = slides.length;
            let slideInterval;

            function showSlide(n) {
                slides.forEach(slide => slide.classList.remove('active'));
                dots.forEach(dot => dot.classList.remove('active'));
                slideIndicators.forEach(indicator => indicator.classList.remove('active'));
                
                slides[n].classList.add('active');
                dots[n].classList.add('active');
                
                const activeIndicators = document.querySelectorAll(`.slide-indicator[data-slide="${n}"]`);
                activeIndicators.forEach(indicator => indicator.classList.add('active'));
                
                currentSlide = n;
            }

            function nextSlide() {
                currentSlide = (currentSlide + 1) % slideCount;
                showSlide(currentSlide);
            }

            function startSlider() {
                slideInterval = setInterval(nextSlide, 5000);
            }

            function stopSlider() {
                clearInterval(slideInterval);
            }

            // --- HOMEPAGE FUNCTIONALITY ---
            function initializeHomepage() {
                // Setup slider event listeners
                dots.forEach(dot => {
                    dot.addEventListener('click', function() {
                        const slideIndex = parseInt(this.getAttribute('data-slide'));
                        showSlide(slideIndex);
                        stopSlider();
                        startSlider();
                    });
                });

                slideIndicators.forEach(indicator => {
                    indicator.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const slideIndex = parseInt(this.getAttribute('data-slide'));
                        showSlide(slideIndex);
                        stopSlider();
                        startSlider();
                    });
                });

                // Setup button event listeners for iframe navigation
                withdrawBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadPage('withdraw.html', 'withdraw');
                });

                walletBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadPage('wallet.html', 'wallet');
                });

                // Start slider
                startSlider();

                // Load user balance
                loadUserBalance();

                // Setup rating frame
                setupRatingFrame();
            }

            function loadUserBalance() {
                if (!currentUserId) return;
                
                userRef.on('value', (snapshot) => {
                    const userData = snapshot.val();
                    if (userData && userData.coins !== undefined) {
                        const balance = userData.coins || 0;
                        balanceAmountElement.textContent = `$${balance.toFixed(2)}`;
                    } else {
                        balanceAmountElement.textContent = '$0.00';
                    }
                }, (error) => {
                    console.error('Error loading balance:', error);
                    balanceAmountElement.textContent = 'Error';
                });
            }

            function setupRatingFrame() {
                if (!currentUserId) return;
                
                const url = `rating.html?userId=${currentUserId}&theme=${currentTheme}&userData=${encodeURIComponent(JSON.stringify({
                    name: userState.firstName || userState.name,
                    coins: userState.coins || 0,
                    chatId: currentUserId,
                    isPremium: userPlanState.premium || false,
                    vipLevel: userPlanState.vipLevel || 0
                }))}`;
                
                ratingFrame.src = url;
            }

            // --- NOTIFICATION SYSTEM ---
            function loadNotifications() {
                if (!notificationsRef) return;
                
                notificationsRef.on('value', (snapshot) => {
                    const notifications = snapshot.val() || {};
                    let unreadCount = 0;
                    
                    const notificationsArray = Object.entries(notifications).map(([id, notif]) => ({
                        id,
                        ...notif
                    })).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    
                    notificationsArray.forEach(notif => {
                        if (!notif.read) unreadCount++;
                    });
                    
                    updateNotificationBadge(unreadCount);
                });
            }

            function updateNotificationBadge(count) {
                unreadNotifications = count;
                if (count > 0) {
                    notificationBadge.textContent = count > 99 ? '99+' : count;
                    notificationBadge.style.display = 'flex';
                } else {
                    notificationBadge.style.display = 'none';
                }
            }

            // Notification frame functionality
            notificationBell.addEventListener('click', () => {
                openNotificationFrame();
            });

            closeNotificationFrame.addEventListener('click', () => {
                closeNotificationFrameModal();
            });

            function openNotificationFrame() {
                if (!currentUserId) return;
                
                const url = `notifications.html?userId=${currentUserId}&theme=${currentTheme}&userData=${encodeURIComponent(JSON.stringify({
                    name: userState.firstName || userState.name,
                    coins: userState.coins || 0,
                    chatId: currentUserId,
                    isPremium: userPlanState.premium || false,
                    vipLevel: userPlanState.vipLevel || 0
                }))}`;
                
                notificationFrame.src = url;
                notificationFrameModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                // Mark all as read when opening
                markAllNotificationsAsRead();
            }

            function closeNotificationFrameModal() {
                notificationFrameModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            function markAllNotificationsAsRead() {
                if (!notificationsRef) return;
                
                notificationsRef.once('value', (snapshot) => {
                    const notifications = snapshot.val() || {};
                    const updates = {};
                    
                    Object.keys(notifications).forEach(id => {
                        if (!notifications[id].read) {
                            updates[`${id}/read`] = true;
                        }
                    });
                    
                    if (Object.keys(updates).length > 0) {
                        notificationsRef.update(updates);
                    }
                });
            }

            // --- SIDE MENU MANAGEMENT ---
            function openSideMenu() {
                sideMenu.classList.add('active');
                menuOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeSideMenu() {
                sideMenu.classList.remove('active');
                menuOverlay.classList.remove('active');
                document.body.style.overflow = 'auto';
            }

            menuNavItem.addEventListener('click', openSideMenu);
            menuOverlay.addEventListener('click', closeSideMenu);

            // Menu item click handlers
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    const fileName = item.dataset.file;
                    loadPage(fileName, 'menu-page');
                    closeSideMenu();
                });
            });

            // Telegram group buttons
            document.querySelectorAll('.tg-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const link = btn.dataset.link;
                    window.open(link, '_blank');
                });
            });

            // --- NAVIGATION ---
            function loadPage(fileName, pageName) {
                if (fileName === 'home') {
                    // Show homepage content
                    homepageContent.style.display = 'block';
                    homeLoading.style.display = 'none';
                    iframeContainer.style.display = 'none';
                    initializeHomepage();
                } else {
                    // Show iframe for other pages
                    homepageContent.style.display = 'none';
                    homeLoading.style.display = 'none';
                    iframeContainer.style.display = 'block';
                    
                    iframeLoading.style.display = 'flex';
                    contentFrame.style.display = 'none';

                    const loadingText = iframeLoading.querySelector('.loading-text');
                    loadingText.textContent = `Loading ${pageName.replace('-', ' ')}...`;

                    // Send user data via URL parameters (original format)
                    const url = `${fileName}?userId=${currentUserId}&theme=${currentTheme}&userData=${encodeURIComponent(JSON.stringify({
                        name: userState.firstName || userState.name,
                        coins: userState.coins || 0,
                        chatId: currentUserId,
                        isPremium: userPlanState.premium || false,
                        vipLevel: userPlanState.vipLevel || 0
                    }))}`;

                    contentFrame.src = url;

                    contentFrame.onload = () => {
                        setTimeout(() => {
                            iframeLoading.style.display = 'none';
                            contentFrame.style.display = 'block';
                        }, 500);
                    };

                    contentFrame.onerror = () => {
                        iframeLoading.innerHTML = '<div class="loading-text">Error loading page</div>';
                        contentFrame.style.display = 'none';
                    };
                }
            }

            function setActiveNav(pageName) {
                navItems.forEach(item => {
                    item.classList.toggle('active', item.dataset.page === pageName);
                });
            }

            navItems.forEach(item => {
                if (item.dataset.page !== 'menu') {
                    item.addEventListener('click', () => {
                        const pageName = item.dataset.page;
                        const fileName = item.dataset.file;
                        
                        setActiveNav(pageName);
                        loadPage(fileName, pageName);
                    });
                }
            });

            // --- USER DATA MANAGEMENT ---
            function saveUserProfileToDatabase(tgUser) {
                const userData = {
                    telegramId: tgUser.id,
                    firstName: tgUser.first_name,
                    lastName: tgUser.last_name || '',
                    username: tgUser.username || '',
                    photoUrl: tgUser.photo_url || 'https://i.ibb.co/L0xJ182/placeholder.png',
                    languageCode: tgUser.language_code || 'en',
                    isPremium: tgUser.is_premium || false,
                    coins: 0,
                    totalMined: 0,
                    level: 1,
                    referrals: 0,
                    referralIncome: 0,
                    isBlocked: false,
                    lastLogin: firebase.database.ServerValue.TIMESTAMP,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    referrerId: tg.initDataUnsafe.start_param || null,
                    claimedReferral: false
                };

                // Save to users collection
                userRef.update(userData);

                // Initialize user plan if not exists
                userPlanRef.once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        const planData = {
                            premium: false,
                            vipLevel: 0,
                            joinDate: firebase.database.ServerValue.TIMESTAMP,
                            lastUpdated: firebase.database.ServerValue.TIMESTAMP
                        };
                        userPlanRef.set(planData);
                    }
                });

                // Send welcome notification
                const welcomeNotification = {
                    title: 'Welcome to Our App!',
                    message: 'Thank you for joining us. Start mining now!',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    read: false,
                    type: 'welcome'
                };
                if (notificationsRef) {
                    notificationsRef.push(welcomeNotification);
                }
            }

            function updateUserProfileFromTelegram() {
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const tgUser = tg.initDataUnsafe.user;
                    
                    const profilePic = tgUser.photo_url || 'https://i.ibb.co/L0xJ182/placeholder.png';
                    document.getElementById('menu-profile-pic').src = profilePic;
                    document.getElementById('user-profile-pic').src = profilePic;
                    
                    const displayName = tgUser.first_name + (tgUser.last_name ? ' ' + tgUser.last_name : '');
                    document.getElementById('menu-profile-name').textContent = displayName;
                    document.getElementById('user-name').textContent = displayName;
                    
                    const usernameText = tgUser.username ? `@${tgUser.username} - ` : '';
                    document.getElementById('menu-profile-username').textContent = 
                        `${usernameText}ID: ${tgUser.id}`;
                    document.getElementById('user-chat-id').textContent = `ID: ${tgUser.id}`;
                }
            }

            function updateMenuProfile() {
                const profilePic = userState.photoUrl || 'https://i.ibb.co/L0xJ182/placeholder.png';
                document.getElementById('menu-profile-pic').src = profilePic;
                document.getElementById('user-profile-pic').src = profilePic;
                
                const displayName = userState.firstName || userState.name || 'Guest User';
                document.getElementById('menu-profile-name').textContent = displayName;
                document.getElementById('user-name').textContent = displayName;
                
                const usernameText = userState.username ? `@${userState.username} - ` : '';
                document.getElementById('menu-profile-username').textContent = 
                    `${usernameText}ID: ${currentUserId}`;
                document.getElementById('user-chat-id').textContent = `ID: ${currentUserId}`;
                
                const vipBadge = document.getElementById('vip-badge');
                if (userPlanState.premium) {
                    vipBadge.textContent = `Premium - VIP ${userPlanState.vipLevel || 0}`;
                    vipBadge.className = 'vip-badge';
                } else {
                    vipBadge.textContent = `Free - VIP ${userPlanState.vipLevel || 0}`;
                    vipBadge.className = 'free-badge';
                }
            }

            // --- INITIALIZATION ---
            function initializeApp() {
                initTheme();

                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const tgUser = tg.initDataUnsafe.user;
                    currentUserId = tgUser.id.toString();
                    
                    console.log('Telegram User Found:', tgUser);
                    
                    updateUserProfileFromTelegram();
                    
                    userRef = database.ref('users/' + currentUserId);
                    userPlanRef = database.ref('usersPlanLevel/' + currentUserId);
                    notificationsRef = database.ref('notifications/' + currentUserId);
                    
                    auth.signInAnonymously().catch(error => console.error("Auth Error:", error));
                    auth.onAuthStateChanged(authUser => {
                        if (authUser) {
                            console.log('Firebase Auth Successful');
                            
                            // Check if user exists, if not create new user
                            userRef.once('value', (snapshot) => {
                                if (!snapshot.exists()) {
                                    console.log('Creating new user in database');
                                    saveUserProfileToDatabase(tgUser);
                                } else {
                                    userState = snapshot.val();
                                    if(userState.isBlocked) {
                                        document.body.innerHTML = '<h1>Your account has been blocked.</h1>';
                                        return;
                                    }
                                    console.log('Existing user found:', userState);
                                }
                            });

                            // Listen for user data changes
                            userRef.on('value', (snapshot) => {
                                userState = snapshot.val() || {};
                                updateMenuProfile();
                            });

                            // Listen for user plan data changes
                            userPlanRef.on('value', (snapshot) => {
                                userPlanState = snapshot.val() || {};
                                updateMenuProfile();
                            });

                            // Load notifications
                            loadNotifications();

                            // Load home page by default
                            loadPage('home', 'home');

                        }
                    });
                } else {
                    console.error('No Telegram user data found');
                    document.body.innerHTML = '<h1>Please open this app in Telegram.</h1>';
                }
            }

            function showNotification(message, isError = false) {
                notification.textContent = message;
                notification.className = `notification show ${isError ? 'error' : ''}`;
                setTimeout(() => notification.classList.remove('show'), 3000);
            }

            // Start the app
            initializeApp();
        });
    </script>
</body>
</html>
